# Athena MySQL Proxy Configuration

[server]
listen_addr = "127.0.0.1"
listen_port = 3307

# Circuit breaker / rate limiting configuration (deprecated, use per-instance limiter)
[circuit]
enabled = true
max_concurrent_per_user_shard = 10
queue_size = 100
queue_timeout_ms = 5000

# =============================================================================
# Sharding Group Configuration
# =============================================================================
#
# 拓扑规则:
# - home_group: 指定非分片表的 db_group 名称
# - shard_indices: 每个 db_group 负责的分片索引列表
#
# 路由过程:
# 1. shard_index = algorithm(shard_column) % shard_count
# 2. 物理表名 = 逻辑表名 + "_" + shard_index
# 3. shard_index → db_group (通过 shard_indices 查找)
#
# 当前配置:
# - home: 非分片表 → athena_rs_test
# - db0: shard_indices=[0,1] → athena_shard_0
# - db1: shard_indices=[2,3] → athena_shard_1

[[groups]]
name = "athena_rs_test"
user = "app_user"
password = "test123"
home_group = "home"

# Sharding rule: orders table sharded by user_id using hash algorithm
[[groups.sharding_rules]]
name = "order_shard"
table_pattern = "orders"
shard_column = "user_id"
algorithm = "hash"
shard_count = 4

# =============================================================================
# Home DB Group (for non-sharded tables)
# =============================================================================
[[groups.db_groups]]
name = "home"
# shard_indices is empty (default) - this is the home group

[[groups.db_groups.instances]]
host = "10.78.81.148"
port = 3306
user = "rw_dbpaas"
password = "GpoqEDWg80vO"
database = "athena_rs_test"
role = "master"

# =============================================================================
# Shard DB 0: athena_shard_0 (orders_0, orders_1)
# =============================================================================
[[groups.db_groups]]
name = "db0"
shard_indices = [0, 1]

[[groups.db_groups.instances]]
host = "10.78.81.148"
port = 3306
user = "rw_dbpaas"
password = "GpoqEDWg80vO"
database = "athena_shard_0"
role = "master"

# =============================================================================
# Shard DB 1: athena_shard_1 (orders_2, orders_3)
# =============================================================================
[[groups.db_groups]]
name = "db1"
shard_indices = [2, 3]

[[groups.db_groups.instances]]
host = "10.78.81.148"
port = 3306
user = "rw_dbpaas"
password = "GpoqEDWg80vO"
database = "athena_shard_1"
role = "master"
